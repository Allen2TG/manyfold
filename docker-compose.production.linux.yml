

services:
  app:
    # ä½¿ç”¨æœ¬åœ°æ„å»ºçš„é•œåƒï¼ŒåŒ…å«ä½ çš„æ‰€æœ‰ä¿®æ”¹
    build:
      context: .
      dockerfile: Dockerfile.custom
      args:
        APP_VERSION: production-linux
        GIT_SHA: local-build
        http_proxy: ${http_proxy}
        https_proxy: ${https_proxy}
    image: manyfold-custom:production-linux
    container_name: manyfold-app
    ports:
      - "3214:3214"
    volumes:
      # âœ… ä½¿ç”¨ Manyfold ç›®å½•å­˜å‚¨æ‰€æœ‰æ•°æ®
      - /mnt/L/Manyfold/models:/models
      - /mnt/L/Manyfold/storage:/usr/src/app/storage
      
    environment:
      # ç”¨æˆ·å’Œç»„IDé…ç½® - ä½¿ç”¨ root (å› ä¸º CIFS æŒ‚è½½ uid=0)
      PUID: 0
      PGID: 0
      
      # æ ¸å¿ƒå®‰å…¨é…ç½® - âœ… å·²ä½¿ç”¨å¼ºéšæœºå¯†é’¥
      # ç”Ÿæˆæ–¹å¼: openssl rand -hex 64
      SECRET_KEY_BASE: 8c60a26098c73abaa408a0b03f932c5fdebe616b5d968ba82e61aecc09e08ee2280670f9853ec233670c151980012af0401aa0fde4c21a5228edfafb10fa8042
      
      # Redisè¿æ¥
      REDIS_URL: redis://redis:6379/1
      
      # PostgreSQLæ•°æ®åº“è¿æ¥
      DATABASE_ADAPTER: postgresql
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_USER: manyfold
      DATABASE_PASSWORD: Phenom2025
      DATABASE_NAME: manyfold
      
      # åº”ç”¨é…ç½®
      RAILS_ENV: production
      RACK_ENV: production
      NODE_ENV: production
      PORT: 3214
      
      # å¤šç”¨æˆ·æ¨¡å¼é…ç½® - å·²å¯ç”¨
      MULTIUSER: enabled
      REGISTRATION_ENABLED: public
      
      # å¯†ç å¼ºåº¦è¦æ±‚ (0=ä¸å®‰å…¨, 4=æœ€å®‰å…¨, é»˜è®¤4)
      # è®¾ç½®ä¸º3ï¼Œåœ¨å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒä¹‹é—´å¹³è¡¡
      MIN_PASSWORD_SCORE: 3
      
      # æ–‡ä»¶ä¸Šä¼ é™åˆ¶ - 100GB (107374182400 å­—èŠ‚)
      MAX_FILE_UPLOAD_SIZE: 107374182400
      # ä»å‹ç¼©åŒ…ä¸­æå–çš„æœ€å¤§æ–‡ä»¶å¤§å° - 100GB
      MAX_FILE_EXTRACT_SIZE: 107374182400
      
      # CIFS/NFS ç‰¹æ®Šé…ç½®ï¼ˆé’ˆå¯¹ç½‘ç»œå…±äº«ï¼‰
      # å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œé¿å…ç½‘ç»œé—®é¢˜
      RAILS_MAX_THREADS: 5
      
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - manyfold
    restart: unless-stopped
    
    # é’ˆå¯¹ CIFS æŒ‚è½½çš„å®‰å…¨é…ç½®è°ƒæ•´
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETUID
      - SETGID
      - FOWNER        # CIFS éœ€è¦
      - DAC_READ_SEARCH  # CIFS éœ€è¦
      
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3214/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s  # CIFS æŒ‚è½½å¯èƒ½éœ€è¦æ›´é•¿å¯åŠ¨æ—¶é—´

  postgres:
    image: postgres:15-alpine
    container_name: manyfold-postgres
    volumes:
      # æ•°æ®åº“æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°é«˜é€Ÿç£ç›˜ï¼Œè€Œéç½‘ç»œå…±äº«
      - db_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: manyfold
      POSTGRES_PASSWORD: Phenom2025  # âœ… å·²è®¾ç½®
      POSTGRES_DB: manyfold
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    restart: unless-stopped
    networks:
      - manyfold
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U manyfold -d manyfold"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: manyfold-redis
    command: redis-server --appendonly yes
    volumes:
      # Redis æ•°æ®ä¹Ÿå­˜å‚¨åœ¨æœ¬åœ°é«˜é€Ÿç£ç›˜
      - redis_data:/data
    restart: unless-stopped
    networks:
      - manyfold
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # æ•°æ®åº“è¿ç§»æœåŠ¡ - è‡ªåŠ¨åˆå§‹åŒ–å’Œè¿ç§»æ•°æ®åº“
  db-migrate:
    image: manyfold-custom:production-linux
    container_name: manyfold-db-migrate
    environment:
      # ä½¿ç”¨ç›¸åŒçš„æ•°æ®åº“é…ç½®
      DATABASE_ADAPTER: postgresql
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_USER: manyfold
      DATABASE_PASSWORD: Phenom2025
      DATABASE_NAME: manyfold
      SECRET_KEY_BASE: 8c60a26098c73abaa408a0b03f932c5fdebe616b5d968ba82e61aecc09e08ee2280670f9853ec233670c151980012af0401aa0fde4c21a5228edfafb10fa8042
      RAILS_ENV: production
      RACK_ENV: production
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - manyfold
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo 'ğŸ—„ï¸  ç­‰å¾…æ•°æ®åº“å®Œå…¨å°±ç»ª...'
        sleep 10
        echo 'ğŸ—„ï¸  å¼€å§‹æ•°æ®åº“è¿ç§»...'
        cd /usr/src/app
        bundle exec rake db:migrate
        echo 'âœ… æ•°æ®åº“è¿ç§»å®Œæˆï¼'
        echo ''
        echo 'ğŸ“Š ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼š'
        echo '   - éƒ¨ç½²ç¯å¢ƒ: Linux'
        echo '   - å­˜å‚¨ä½ç½®: /mnt/L/Manyfold'
        echo '   - å¤šç”¨æˆ·æ¨¡å¼: å·²å¯ç”¨'
        echo '   - å¯†ç å¼ºåº¦è¦æ±‚: 3'
        echo '   - æ–‡ä»¶ä¸Šä¼ é™åˆ¶: 100GB'
        echo ''
        echo 'ğŸŒ è®¿é—®åœ°å€: http://10.100.7.222:3214'
        echo ''
        echo 'âœ… è¿ç§»æœåŠ¡æ­£å¸¸é€€å‡º'
        exit 0
    restart: "no"  # åªè¿è¡Œä¸€æ¬¡

volumes:
  # æ•°æ®åº“å’Œ Redis ä½¿ç”¨æœ¬åœ° Docker å·ï¼ˆæ›´å¿«æ›´å¯é ï¼‰
  db_data:
    driver: local
  redis_data:
    driver: local
  # å¦‚æœ CIFS ä¸å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨æœ¬åœ°å·ä½œä¸ºå¤‡é€‰
  # app_storage:
  #   driver: local

networks:
  manyfold:
    driver: bridge


